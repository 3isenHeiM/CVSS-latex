\documentclass{article}
\usepackage[a4paper, total={6in, 8in}]{geometry}
\usepackage{pgfmath}
\usepackage[dvipsnames,svgnames,table]{xcolor}
\usepackage{lipsum}
\usepackage[skins]{tcolorbox}
\tcbuselibrary{xparse}
\usepackage{xstring}
\usepackage{hyperref}

% Equations from https://www.first.org/cvss/specification-document#i8
% Values from https://www.first.org/cvss/specification-document#i8.4

%1 Attack Vector
%Network N, Adjacent A, Local L, Physical P
\ExplSyntaxOn

\cs_new:Npn \__CVSS_parseAttackVector:n #1 {
    \str_case_e:nnF {#1}
    {
        { N } { 0.85 } % Network
        { A } { 0.62 } % Adjacent
        { L } { 0.55 } % Local
        { P } { 0.2 }  % Physical
    }
    { msg_expandable_error:nnn { CVSS_parseAttackVector } { invalid-option } {#1} }
}
\msg_new:nnn { CVSS_parseAttackVector } { invalid-option }
{ Value~'#1'~invalid~for~\iow_char:N\\parseAttackVector. }


%2 Attack Complexity
%Low L, High H
\cs_new:Npn \__CVSS_parseAttackComplexity:n #1 {
    \str_case_e:nnF {#1}
    {
        { H } { 0.44 }	% High
        { L } { 0.77 }	% Low
    }
    { msg_expandable_error:nnn { CVSS_parseAttackComplexity } { invalid-option } {#1} }
}
\msg_new:nnn { CVSS_parseAttackComplexity } { invalid-option }
{ Value~'#1'~invalid~for~\iow_char:N\\parseAttackComplexity. }


%3 Privileges Required
%None N, Low L, High H
\cs_new:Npn \__CVSS_parsePrivilegesRequired:nn #1#2 {
% #1 Privilege Required
% #2 Scope
    \str_case_e:nnF {#2}
    {
        { U } { \__CVSS_parsePrivilegesRequiredScopeUnchanged:n {#1} }
        { C } { \__CVSS_parsePrivilegesRequiredScopeChanged:n {#1} }
    }
    { \msg_error:nn { parsePrivilegesRequired } { invalid-option } {#1} }
}

\cs_new:Npn \__CVSS_parsePrivilegesRequiredScopeUnchanged:n #1 {
    \str_case_e:nnF {#1}
    {
        { N } { 0.85 } % None
        { L } { 0.62 } % Low
        { H } { 0.27 } % High
    }
    { msg_expandable_error:nnn { CVSS_parsePrivilegesRequiredScopeUnchanged } { invalid-option } {#1} }
}
\msg_new:nnn { CVSS_parsePrivilegesRequiredScopeUnchanged } { invalid-option }
{ Value~'#1'~invalid~for~\iow_char:N\\parsePrivilegesRequiredScopeUnchanged. }


\cs_new:Npn \__CVSS_parsePrivilegesRequiredScopeChanged:n #1 {
    \str_case_e:nnF {#1}
    {
        { N } { 0.85 } % None
        { L } { 0.68 } % Low
        { H } { 0.50 } % High
    }
    { msg_expandable_error:nnn { CVSS_parsePrivilegesRequiredScopeChanged } { invalid-option } {#1} }
}
\msg_new:nnn { CVSS_parsePrivilegesRequiredScopeChanged } { invalid-option }
{ Value~'#1'~invalid~for~\iow_char:N\\parsePrivilegesRequiredScopeChanged. }

%4 User Interaction
%None N, Required R
\cs_new:Npn \__CVSS_parseUserInteraction:n #1 {
    \str_case_e:nnF {#1}
    {
        { N } { 0.85 } % None
        { R } { 0.62 } % Required
    }
    { msg_expandable_error:nnn { CVSS_parseUserInteraction } { invalid-option } {#1} }
}
\msg_new:nnn { CVSS_parseUserInteraction } { invalid-option }
{ Value~'#1'~invalid~for~\iow_char:N\\parseUserInteraction. }

%5 Scope
%Unchanged U, Changed C
% (See parsePrivilegesRequired)

%6 Confidentiality Impact
%High H, Low L, None N
%7 Integrity Impact
%High H, Low L, None N
%8 Availability Impact
%High H, Low L, None N
\cs_new:Npn \__CVSS_parseCIA:n #1 {
    \str_case_e:nnF {#1}
    {
        { H } { 0.56 }
        { L } { 0.22 }
        { N } { 0.00 }
    }
    { msg_expandable_error:nnn { CVSS_parseCIA } { invalid-option } {#1} }
}
\msg_new:nnn { CVSS_parseCIA } { invalid-option }
{ Value~'#1'~invalid~for~\iow_char:N\\parseCIA. }


\cs_new:Npn \__CVSS_calcIscBase:nnn #1#2#3 {
    % #1 Confidentiality Impact %High H, Low L, None N
    % #2 Integrity Impact %High H, Low L, None N
    % #3 Availability Impact %High H, Low L, None N
    \fp_eval:n { 1 - ( (1 - (\__CVSS_parseCIA:n {#1})) * (1 - (\__CVSS_parseCIA:n {#2})) * (1 - (\__CVSS_parseCIA:n {#3})) ) }
}

\cs_new:Npn \__CVSS_calcIsc:nn #1#2 {
    % #1 = Scope
    % #2 = ISCBase
    % Scope Unchanged 6.42 × ISCBase
    % Scope Changed 7.52 × [ISCBase−0.029] − 3.25 × [ISCBase−0.02]15
    \str_case_e:nnF {#1}
    {
        { U } { \fp_eval:n { 6.42 * (#2) } } % Scope UNCHANGED
        { C } { \fp_eval:n { 7.52 * ( (#2) - 0.029 ) - 3.25 * ( (#2) - 0.02 )^15 } } % Scope CHANGED
    }
    { \msg_error:nn { calcIsc } { invalid-option } {#1} }
}%


\cs_new:Npn \__CVSS_calcAndParseExploitability:nnnnn #1#2#3#4#5 {
    % #1 Attack Vector
    % #2 Attack Complexity
    % #3 Privileges Required
    % #4 User Interaction
    % #5 Scope
    % 8.22 × AttackVector × AttackComplexity × PrivilegeRequired × UserInteraction
    \fp_eval:n { 8.22 * (\__CVSS_parseAttackVector:n {#1}) * (\__CVSS_parseAttackComplexity:n {#2}) * (\__CVSS_parsePrivilegesRequired:nn {#3}{#5}) * (\__CVSS_parseUserInteraction:n {#4}) }%
}

% https://tex.stackexchange.com/a/615358/28926
\cs_new:Npn \__CVSS_roundup:n #1 {
    \fp_eval:n { ceil(#1,1) }
    \fp_compare:nT { ceil(#1,1)=ceil(#1,0) } {.0}
}


\NewExpandableDocumentCommand \cvssBaseScore {mmmmmmmm}{%
%\cs_new:Npn \cvssBaseScore #1#2#3#4#5#6#7#8 {
    % #1 Attack Vector %Network N, Adjacent A, Local L, Physical P
    % #2 Attack Complexity %Low L, High H
    % #3 Privileges Required %None N, Low L, High H
    % #4 User Interaction %None N, Required R
    % #5 Scope %Unchanged U, Changed C
    % #6 Confidentiality Impact %High H, Low L, None N
    % #7 Integrity Impact %High H, Low L, None N
    % #8 Availability Impact %High H, Low L, None N
%
% 	\calcIscBase{#6}{#7}{#8}}  = ISCbase
%    \calcIsc{#5}{\calcIscBase{#6}{#7}{#8}} =  ISC
%    \fp_set:Nn \l_CVSS_calcISCbase_fp { \calcIscBase{#6}{#7}{#8} }
%    \fp_set:Nn \l_CVSS_calcISC_fp { \calcIsc{#5}{\l_CVSS_calcISCbase_fp} }

%    \fp_show:N \l_CVSS_calcISC_fp
    %
    \fp_compare:nTF { \__CVSS_calcIsc:nn {#5}{\__CVSS_calcIscBase:nnn {#6}{#7}{#8}} <= 0 }
    % IF ISC <=0
    {
        % ISC <=0
        0.0
    }{
        % ISC > 0
        \str_case_e:nnF {#5}
        {
            { U } { % SCOPE UNCHANGED
                \fp_eval:n { \__CVSS_roundup:n { min( ((\__CVSS_calcIsc:nn {#5}{\__CVSS_calcIscBase:nnn {#6}{#7}{#8}}) + (\__CVSS_calcAndParseExploitability:nnnnn {#1}{#2}{#3}{#4}{#5})), 10) } }%
            }
            { C } { % SCOPE CHANGED
                \fp_eval:n { \__CVSS_roundup:n { min( (1.08 * ((\__CVSS_calcIsc:nn {#5}{\__CVSS_calcIscBase:nnn {#6}{#7}{#8}}) + (\__CVSS_calcAndParseExploitability:nnnnn {#1}{#2}{#3}{#4}{#5}))), 10) } }%
            }
        }
        { \msg_error:nn { cvssBaseScore } { invalid-option } {#1} }
    }%
}


\ExplSyntaxOff

\newcommand{\cvssBaseScorePretty}[8]{%
    \dumpSettingsShort{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
    ~~
    \formatDump{Score}{\cvssBaseScore{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}}
}

\newcommand{\cvssBaseScoreUsual}[8]{%
    \cvssBaseScore{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
    \quad CVSS:3.1/\dumpSettingsInline{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}%

\newcommand{\cvssTest}{%
    
    Should be 7.3: \cvssBaseScore{N}{L}{N}{N}{U}{L}{L}{L}

	Should be 8.3: \cvssBaseScore{N}{L}{N}{N}{C}{L}{L}{L}%
	
	Should be 9.9: \cvssBaseScore{N}{L}{N}{N}{C}{L}{L}{H}%
	
	Should be 9.9: \cvssBaseScore{N}{L}{N}{N}{C}{L}{H}{L}%
	
	Should be 7.2: \cvssBaseScore{N}{L}{N}{N}{C}{L}{L}{N}%
	
	Should be 7.1: \cvssBaseScore{A}{L}{N}{N}{C}{L}{L}{L}%
	
	Should be 5.8: \cvssBaseScore{A}{H}{N}{N}{C}{L}{L}{L}%
	
	Should be 5.5: \cvssBaseScore{A}{H}{L}{N}{C}{L}{L}{L}%
	
	Should be 5.1: \cvssBaseScore{A}{H}{L}{R}{C}{L}{L}{L}%
	
	Should be 4.3: \cvssBaseScore{A}{H}{L}{R}{U}{L}{L}{L}%
	
	Should be 0.0: \cvssBaseScore{N}{L}{N}{N}{C}{N}{N}{N}
	
	Should be 0.0: \cvssBaseScore{N}{L}{N}{N}{U}{N}{N}{N}
}



\newcommand{\parse}[8]{%
    \parseAttackVector{#1}%
    \parseAttackComplexity{#2}%
    \parsePrivilegesRequired{#3}{#5}%
    \parseUserInteraction{#4}%
    \parseCIA{#6}%
    \parseCIA{#7}%
    \parseCIA{#8}%
}%

\newcommand{\dumpSettings}[8]{%
    
    \formatDump{Attack Vector}{#1}\\%
    \formatDump{Attack Complexity}{#2}\\%
    \formatDump{Privileges Required}{#3}\\%
    \formatDump{User Interaction}{#4}\\%
    \formatDump{Scope}{#5}\\%
    \formatDump{Confidentiality Impact}{#6}\\%
    \formatDump{Integrity Impact}{#7}\\%
    \formatDump{Availability Impact}{#8}\\%
}

\newcommand{\dumpSettingsShort}[8]{%
    
    \formatDump{AV}{#1}%
    \formatDump{AC}{#2}%
    \formatDump{PR}{#3}%
    \formatDump{UI}{#4}%
    \formatDump{S}{#5}%
    \formatDump{C}{#6}%
    \formatDump{I}{#7}%
    \formatDump{A}{#8}%
}

\newcommand{\dumpSettingsInline}[8]{%
    AV:#1/AC:#2/PR:#3/UI:#4/S:#5/C:#6/I:#7/A:#8%
}

\newcommand{\formatDump}[2]{%
    \textbf{#1:} #2\enskip%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ADDITIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\ExplSyntaxOn

\str_new:N \l_cvssAV_str
\str_new:N \l_cvssAC_str
\str_new:N \l_cvssPR_str
\str_new:N \l_cvssUI_str
\str_new:N \l_cvssS_str
\str_new:N \l_cvssC_str
\str_new:N \l_cvssI_str
\str_new:N \l_cvssA_str

%\NewExpandableDocumentCommand \computeCVSS { m }{%
\cs_new_protected:Npn \computeCVSS #1 {
    % A group allows nesting
    \group_begin:
    % Split into parts (separated by "/")
    \seq_set_split:Nnn \l__tnscalc_splittab_seq { / } { #1 }
    % Check taht there are 8 items
    \int_compare:nNnTF {(\seq_count:N \l__tnscalc_splittab_seq)} = {8}{}{FALSE}
    % Get the 1st item out of the list : AV
    \seq_pop_left:NN \l__tnscalc_splittab_seq \l__tnscalc_tempAV_tl
    % Check item's value
    \str_case_e:nnF {\l__tnscalc_tempAV_tl}
    {
        {AV:N} { \str_set:Nn \l_cvssAV_str {N} }
        {AV:A} { \str_set:Nn \l_cvssAV_str {A} }
        {AV:L} { \str_set:Nn \l_cvssAV_str {L} }
        {AV:P} { \str_set:Nn \l_cvssAV_str {P} }
    }
    { \PackageError{CVSS}{"\l__tnscalc_tempAV_tl" is not a CVSS AV value}{<help>}}
    %
    \seq_pop_left:NN \l__tnscalc_splittab_seq \l__tnscalc_tempAC_tl
    \str_case_e:nnF {\l__tnscalc_tempAC_tl}
    {
        {AC:H} { \str_set:Nn \l_cvssAC_str {H} }
        {AC:L} { \str_set:Nn \l_cvssAC_str {L} }
    }
    { \PackageError{CVSS}{"\l__tnscalc_tempAC_tl" is not a CVSS AC value}{<help>}}
    %
    \seq_pop_left:NN \l__tnscalc_splittab_seq \l__tnscalc_tempPR_tl
    \str_case_e:nnF {\l__tnscalc_tempPR_tl}
    {
        {PR:N} { \str_set:Nn \l_cvssPR_str {N} }
        {PR:L} { \str_set:Nn \l_cvssPR_str {L} }
        {PR:H} { \str_set:Nn \l_cvssPR_str {H} }
    }
    { \PackageError{CVSS}{"\l__tnscalc_tempPR_tl" is not a CVSS PR value}{<help>}}
    %
    \seq_pop_left:NN \l__tnscalc_splittab_seq \l__tnscalc_tempUI_tl
    \str_case_e:nnF {\l__tnscalc_tempUI_tl}
    {
        {UI:N} { \str_set:Nn \l_cvssUI_str {N} }
        {UI:R} { \str_set:Nn \l_cvssUI_str {R} }
    }
    { \PackageError{CVSS}{"\l__tnscalc_tempUI_tl" is not a CVSS AV value}{<help>}}
    %
    \seq_pop_left:NN \l__tnscalc_splittab_seq \l__tnscalc_tempS_tl
    \str_case_e:nnF {\l__tnscalc_tempS_tl}
    {
        {S:C} { \str_set:Nn \l_cvssS_str {C} }
        {S:U} { \str_set:Nn \l_cvssS_str {U} }
    }
    { \PackageError{CVSS}{"\l__tnscalc_tempS_tl" is not a CVSS S value}{<help>}}
    %
    \seq_pop_left:NN \l__tnscalc_splittab_seq \l__tnscalc_tempC_tl
    \str_case_e:nnF {\l__tnscalc_tempC_tl}
    {
        {C:N} { \str_set:Nn \l_cvssC_str {N} }
        {C:L} { \str_set:Nn \l_cvssC_str {L} }
        {C:H} { \str_set:Nn \l_cvssC_str {H} }
    }
    { \PackageError{CVSS}{"\l__tnscalc_tempC_tl" is not a CVSS C value}{<help>}}
    %
    \seq_pop_left:NN \l__tnscalc_splittab_seq \l__tnscalc_tempI_tl
    \str_case_e:nnF {\l__tnscalc_tempI_tl}
    {
        {I:N} { \str_set:Nn \l_cvssI_str {N} }
        {I:L} { \str_set:Nn \l_cvssI_str {L} }
        {I:H} { \str_set:Nn \l_cvssI_str {H} }
    }
    { \PackageError{CVSS}{"\l__tnscalc_tempI_tl" is not a CVSS I value}{<help>}}
    %
    \seq_pop_left:NN \l__tnscalc_splittab_seq \l__tnscalc_tempA_tl
    \str_case_e:nnF {\l__tnscalc_tempA_tl}
    {
        {A:N} { \str_set:Nn \l_cvssA_str {N} }
        {A:L} { \str_set:Nn \l_cvssA_str {L} }
        {A:H} { \str_set:Nn \l_cvssA_str {H} }
    }
    { \PackageError{CVSS}{"\l__tnscalc_tempA_tl" is not a CVSS I value}{<help>}}

    \cvssBaseScore{\l_cvssAV_str}
    {\l_cvssAC_str}
    {\l_cvssPR_str}
    {\l_cvssUI_str}
    {\l_cvssS_str}
    {\l_cvssC_str}
    {\l_cvssI_str}
    {\l_cvssA_str}%
%    %
    \group_end:
}%
\ExplSyntaxOff

% These are the thresholds
\def\scoreCrit{9.0}
\def\scoreHigh{7.0}
\def\scoreMed{4.0}
\def\scoreLow{0.1}

% This function will output the CVSS catergory based on the input score
\ExplSyntaxOn
\NewExpandableDocumentCommand \category { m }{%
%\newcommand{\category}[1]{
    \fp_compare:nNnTF {#1}<{\scoreLow}{None}
    {
        \fp_compare:nNnTF{#1}<{\scoreMed}{Low}
        {
            \fp_compare:nNnTF{#1}<{\scoreHigh}{Medium}
            {
                \fp_compare:nNnTF{#1}<{\scoreCrit}{High}
                {Critical}
            }%
        }%
    }%
}%
\ExplSyntaxOff


\colorlet{color@cvss@None}{black!20}
\definecolor{color@cvss@Low}{rgb}{0.0, 0.65, 0.31}
\definecolor{color@cvss@Medium}{RGB}{255, 221, 0}
\colorlet{color@cvss@High}{orange}
\definecolor{color@cvss@Critical}{RGB}{255, 0, 0}

\DeclareTotalTCBox{\cvssTag}{m}{
    enhanced,nobeforeafter,
    tcbox raise base,
    boxrule=0.4pt,
    top=0mm,bottom=0mm,right=1mm,left=1mm,
    arc=1pt,
    boxsep=2pt,
    colframe=color@cvss@#1,
    colback=tcbcolframe,
    coltext=black,
}{#1}%

\MakeRobust\cvssTag

\ifdefined\pdfstringdefDisableCommands
\pdfstringdefDisableCommands{\def\cvssTag#1{'#1'}}
\fi

\newcommand{\cvssBaseScoreRatingDEBUG}[8]{%
    \newcommand{\CVSSscore}{\cvssBaseScore{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}}
    CVSS score is \CVSSscore

    The category of \CVSSscore{} is \category{\CVSSscore}.

    The tag is \cvssTag{\category{\CVSSscore}}.
}%


\newcommand{\cvssBaseScoreRating}[8]{%
    \renewcommand{\CVSSscore}{\cvssBaseScore{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}}
    \def\inline{\dumpSettingsInline{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}}%
    \cvssTag{\category{\CVSSscore}} \quad \CVSSscore \quad%
    CVSS:3.1/\inline%

    \href{https://www.first.org/cvss/calculator/3.1\#CVSS:3.1/\inline}{\inline}
}%


\ExplSyntaxOn
\str_new:N \l_input_str

%\NewDocumentCommand \testCompute { m }{%
%\cs_new_protected:Npn \testCompute #1 {
%%    \str_set:Nn \l_input_str { #1 }
%    % CALLS basicMACRO
%%    \computeCVSS{\l_input_str} \par
%    %\newcommand{\category}[1]{
%%    \fp_set:Nn \l_teeeest_fp { \computeCVSS{#1} }
%    This~is~the~score~:~\computeCVSS{#1}
%%    \fp_eval:n {\computeCVSS{#1} }
%}%

\cs_new:Npn \testCompute:n #1
{
    \exp_args:Ne \__testCompute_internal:n
    { \fp_eval:n {\computeCVSS{#1} } }
}
\cs_new:Npn \__testCompute_internal:n #1
{ \fp_eval:n { \textbf{#1} } }

\ExplSyntaxOff

\setlength{\parindent}{0pt}

\begin{document}
	


    \cvssTest{}

    \section{Demo}

    \cvssBaseScorePretty{N}{L}{N}{N}{U}{L}{L}{L}

    \cvssBaseScorePretty{N}{L}{N}{N}{C}{L}{L}{L}

    \cvssBaseScorePretty{N}{H}{N}{R}{U}{L}{L}{L}

    \cvssBaseScore{N}{L}{N}{N}{U}{L}{L}{L}

    \cvssBaseScore{N}{L}{N}{N}{C}{L}{L}{L}

    \cvssBaseScore{N}{H}{N}{R}{U}{L}{L}{L}


    A: \cvssBaseScore{N}{L}{N}{N}{U}{L}{L}{L}

    B: \cvssBaseScore{N}{L}{N}{N}{C}{L}{L}{L}

    C: \cvssBaseScore{N}{H}{N}{R}{U}{L}{L}{L}

    \section{Additions}

    \texttt{\textbackslash cvssBaseScoreRatingDEBUG} : \cvssBaseScoreRatingDEBUG{N}{H}{N}{R}{U}{L}{L}{L}

    ---

    \texttt{\textbackslash cvssBaseScoreRating} : \cvssBaseScoreRating{N}{L}{N}{N}{C}{L}{L}{L}

    ---

    \texttt{\textbackslash cvssBaseScoreUsual} : \cvssBaseScoreUsual{N}{L}{N}{N}{U}{L}{L}{L}

    ---

    \computeCVSS{AV:L/AC:H/PR:N/UI:R/S:U/C:H/I:L/A:N}
    
    \category{5.3}
    
    \cvssTag{\category{5.3}}

---

%    \category{\computeCVSS{AV:L/AC:H/PR:N/UI:R/S:U/C:H/I:L/A:N}}
%    \testCompute{AV:L/AC:H/PR:N/UI:R/S:U/C:H/I:L/A:N}


\end{document}